{% extends 'backend/layouts/master.html' %}
{% load static %}
{% block title %}Dashboard | {% endblock %}
{% block content %}

<!-- Begin Page Content -->
<div class="container-fluid" id="dashboardApp">

    <!-- Page Heading -->
    <div class="d-sm-flex align-items-center justify-content-between mb-4">
        <h1 class="h3 mb-0 text-gray-800">Dashboard</h1>
        <a href="#" class="d-none d-sm-inline-block btn btn-sm btn-primary shadow-sm"><i
                class="fas fa-download fa-sm text-white-50"></i> Generate Report</a>
    </div>

    <!-- Loading Spinner -->
    <div v-if="loading" class="text-center py-4">
        <div class="spinner-border text-primary" role="status">
            <span class="sr-only">Loading...</span>
        </div>
    </div>

    <!-- Content Row -->
    <div class="row" v-if="!loading">

        <!-- Branches Card -->
        <div class="col-xl-4 col-md-6 mb-3">
            <div class="card border-left-primary shadow h-100 py-2">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs font-weight-bold text-primary text-uppercase mb-1">
                               Branches</div>
                            <div class="h5 mb-0 font-weight-bold text-gray-800">[[ branches.length ]]</div>
                        </div>
                        <div class="col-auto">
                            <i class="fas fa-building fa-2x text-gray-300"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Bookings Card -->
        <div class="col-xl-4 col-md-6 mb-3">
            <div class="card border-left-success shadow h-100 py-2">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs font-weight-bold text-success text-uppercase mb-1">
                                Bookings</div>
                            <div class="h5 mb-0 font-weight-bold text-gray-800">[[ bookings.length ]]</div>
                        </div>
                        <div class="col-auto">
                            <i class="fas fa-calendar-check fa-2x text-gray-300"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Customers Card -->
        <div class="col-xl-4 col-md-6 mb-3">
            <div class="card border-left-info shadow h-100 py-2">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs font-weight-bold text-info text-uppercase mb-1">
                                Customers</div>
                            <div class="h5 mb-0 font-weight-bold text-gray-800">[[ customers.length ]]</div>
                        </div>
                        <div class="col-auto">
                            <i class="fas fa-users fa-2x text-gray-300"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

    </div>

    <div class="row" v-if="!loading">

        <!-- Services Card -->
        <div class="col-xl-4 col-md-6 mb-3">
            <div class="card border-left-secondary shadow h-100 py-2">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs font-weight-bold text-secondary text-uppercase mb-1">
                               Services</div>
                            <div class="h5 mb-0 font-weight-bold text-gray-800">[[ services.length ]]</div>
                        </div>
                        <div class="col-auto">
                            <i class="fas fa-box-open fa-2x text-gray-300"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Categories Card -->
        <div class="col-xl-4 col-md-6 mb-3">
            <div class="card border-left-warning shadow h-100 py-2">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs font-weight-bold text-warning text-uppercase mb-1">
                                Categories</div>
                            <div class="h5 mb-0 font-weight-bold text-gray-800">[[ categories.length ]]</div>
                        </div>
                        <div class="col-auto">
                            <i class="fas fa-layer-group fa-2x text-gray-300"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Invoices Card -->
        <div class="col-xl-4 col-md-6 mb-3">
            <div class="card border-left-danger shadow h-100 py-2">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs font-weight-bold text-danger text-uppercase mb-1">
                                Invoices</div>
                            <div class="h5 mb-0 font-weight-bold text-gray-800">[[ invoices.length ]]</div>
                        </div>
                        <div class="col-auto">
                            <i class="fas fa-file-invoice fa-2x text-gray-300"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Content Row -->
    <div class="row">

        <!-- Area Chart -->
        <div class="col-xl-8 col-lg-7">
            <div class="card shadow mb-4">
                <!-- Card Header - Dropdown -->
                <div
                    class="card-header py-3 d-flex flex-row align-items-center justify-content-between">
                    <h6 class="m-0 font-weight-bold text-primary">Data Overview</h6>
                </div>
                <!-- Card Body -->
                <div class="card-body">
                    <div class="chart-area">
                        <canvas id="myAreaChart"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <!-- Pie Chart -->
        <div class="col-xl-4 col-lg-5">
            <div class="card shadow mb-4">
                <!-- Card Header - Dropdown -->
                <div
                    class="card-header py-3 d-flex flex-row align-items-center justify-content-between">
                    <h6 class="m-0 font-weight-bold text-primary">Data Distribution</h6>
                </div>
                <!-- Card Body -->
                <div class="card-body">
                    <div class="chart-pie pt-4 pb-2">
                        <canvas id="myPieChart"></canvas>
                    </div>
                    <div class="mt-4 text-center small">
                        <span class="mr-2" v-for="(item, index) in pieChartData" :key="index">
                            <i :class="['fas', 'fa-circle', `text-${item.color}`]"></i> [[ item.label ]]
                        </span>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <!-- Content Row -->
</div>
<!-- /.container-fluid -->

<!-- Vue & Axios -->
<script src="https://unpkg.com/vue@3/dist/vue.global.prod.js"></script>
<script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let cookie of cookies) {
            cookie = cookie.trim();
            if (cookie.startsWith(name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

const csrfToken = getCookie('csrftoken');
axios.defaults.xsrfHeaderName = "X-CSRFToken";
axios.defaults.xsrfCookieName = "csrftoken";
axios.defaults.headers.common['X-CSRFToken'] = csrfToken;
axios.defaults.withCredentials = true;

const { createApp } = Vue;

createApp({
    delimiters: ['[[', ']]'],
    data() {
        return {
            loading: true,
            branches: [],
            bookings: [],
            customers: [],
            services: [],
            categories: [],
            invoices: [],
            areaChart: null,
            pieChart: null,
            pieChartData: []
        };
    },
    mounted() {
        this.fetchAllData();
    },
    watch: {
        // Watch for data changes to update charts
        branches: 'updateCharts',
        bookings: 'updateCharts',
        customers: 'updateCharts',
        services: 'updateCharts',
        categories: 'updateCharts',
        invoices: 'updateCharts'
    },
    methods: {
        async fetchAllData() {
            try {
                this.loading = true;

                // Fetch all data in parallel using your existing APIs
                const [branchesRes, bookingsRes, customersRes, servicesRes, categoriesRes, invoicesRes] = await Promise.all([
                    axios.get('/api/branches/'),
                    axios.get('/api/bookings/'),
                    axios.get('/api/customers/'),
                    axios.get('/api/services/'),
                    axios.get('/api/categories/'),
                    axios.get('/api/invoices/')
                ]);

                // Get the arrays from your APIs
                this.branches = branchesRes.data.results || branchesRes.data;
                this.bookings = bookingsRes.data.results || bookingsRes.data;
                this.customers = customersRes.data.results || customersRes.data;
                this.services = servicesRes.data.results || servicesRes.data;
                this.categories = categoriesRes.data.results || categoriesRes.data;
                this.invoices = invoicesRes.data.results || invoicesRes.data;

            } catch (error) {
                console.error("Error fetching dashboard data:", error);
            } finally {
                this.loading = false;
            }
        },

        updateCharts() {
            if (this.loading) return;
            this.updateAreaChart();
            this.updatePieChart();
        },

        updateAreaChart() {
            const ctx = document.getElementById('myAreaChart');
            if (!ctx) return;

            // Destroy existing chart if it exists
            if (this.areaChart) {
                this.areaChart.destroy();
            }

            // Use the lengths of your arrays for the area chart
            const data = [
                this.branches.length,
                this.bookings.length,
                this.customers.length,
                this.services.length,
                this.categories.length,
                this.invoices.length
            ];

            const labels = ['Branches', 'Bookings', 'Customers', 'Services', 'Categories', 'Invoices'];

            this.areaChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Total Count',
                        data: data,
                        backgroundColor: 'rgba(78, 115, 223, 0.05)',
                        borderColor: 'rgba(78, 115, 223, 1)',
                        pointRadius: 3,
                        pointBackgroundColor: 'rgba(78, 115, 223, 1)',
                        pointBorderColor: 'rgba(78, 115, 223, 1)',
                        pointHoverRadius: 5,
                        pointHoverBackgroundColor: 'rgba(78, 115, 223, 1)',
                        pointHoverBorderColor: 'rgba(78, 115, 223, 1)',
                        pointHitRadius: 10,
                        pointBorderWidth: 2,
                        tension: 0.3,
                        fill: true
                    }]
                },
                options: {
                    maintainAspectRatio: false,
                    layout: {
                        padding: {
                            left: 10,
                            right: 25,
                            top: 25,
                            bottom: 0
                        }
                    },
                    scales: {
                        x: {
                            grid: {
                                display: false
                            }
                        },
                        y: {
                            beginAtZero: true,
                            ticks: {
                                precision: 0
                            }
                        }
                    }
                }
            });
        },

        updatePieChart() {
            const ctx = document.getElementById('myPieChart');
            if (!ctx) return;

            // Destroy existing chart if it exists
            if (this.pieChart) {
                this.pieChart.destroy();
            }

            // Use your array lengths for the pie chart
            this.pieChartData = [
                { label: 'Branches', value: this.branches.length, color: 'primary' },
                { label: 'Bookings', value: this.bookings.length, color: 'success' },
                { label: 'Customers', value: this.customers.length, color: 'info' },
                { label: 'Services', value: this.services.length, color: 'secondary' },
                { label: 'Categories', value: this.categories.length, color: 'warning' },
                { label: 'Invoices', value: this.invoices.length, color: 'danger' }
            ];

            // Filter out zero values
            const filteredData = this.pieChartData.filter(item => item.value > 0);

            if (filteredData.length === 0) {
                filteredData.push({ label: 'No Data', value: 1, color: 'secondary' });
            }

            this.pieChart = new Chart(ctx, {
                type: 'pie',
                data: {
                    labels: filteredData.map(item => item.label),
                    datasets: [{
                        data: filteredData.map(item => item.value),
                        backgroundColor: filteredData.map(item => {
                            return `var(--bs-${item.color})`;
                        }),
                        hoverBackgroundColor: filteredData.map(item => {
                            return `var(--bs-${item.color})`;
                        }),
                        hoverBorderColor: "rgba(234, 236, 244, 1)",
                    }],
                },
                options: {
                    maintainAspectRatio: false,
                    tooltips: {
                        backgroundColor: "rgb(255,255,255)",
                        bodyFontColor: "#858796",
                        borderColor: '#dddfeb',
                        borderWidth: 1,
                        xPadding: 15,
                        yPadding: 15,
                        displayColors: false,
                        caretPadding: 10,
                    },
                    legend: {
                        display: false
                    },
                    cutout: 0,
                },
            });

            this.pieChartData = filteredData;
        }
    }
}).mount('#dashboardApp');
</script>

{% endblock %}