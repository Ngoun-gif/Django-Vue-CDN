{% extends "backend/layouts/master.html" %}

{% block content %}
<div id="invoiceApp" class="container-fluid px-4 py-3" style="position: relative;">
    <nav aria-label="breadcrumb" class="mb-4">
        <ol class="breadcrumb">
            <li class="breadcrumb-item"><a href="#">Dashboard</a></li>
            <li class="breadcrumb-item active">Invoices</li>
        </ol>
    </nav>

    <div v-if="message" class="alert alert-success" role="alert">
        [[ message ]]
    </div>

    <div class="d-flex justify-content-between align-items-center mb-3">
        <div class="w-50">
            <div class="input-group">
                <input
                    v-model="searchQuery"
                    @input="debouncedFetch"
                    type="text"
                    class="form-control"
                    placeholder="Search invoices..."
                    aria-label="Search invoices"
                >
            </div>
        </div>

        <button class="btn btn-primary" @click="openModal('add')">
            <i class="fas fa-plus me-1"></i> Create Invoice
        </button>
    </div>

    <div class="table-responsive">
        <table class="table table-bordered table-hover text-center">
            <thead class="table-light">
                <tr>
                    <th>#</th>
                    <th>Invoice Number</th>
                    <th>Invoice Date</th>
                    <th>Branch</th>
                    <th>Customer</th>
                    <th>Booking</th>
                    <th>Services</th>
                    <th>Subtotal</th>
                    <th>Tax</th>
                    <th>Additional Fee</th>
                    <th>Grand Total</th>
                    <th>Status</th>
                    <th>Payment Method</th>
                    <th>Payment Deadline</th>
                    <th>Notes</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                <tr v-for="(invoice, index) in invoices" :key="invoice.id">
                    <td>[[ index + 1 + (currentPage - 1) * perPage ]]</td>
                    <td>
                        <strong class="text-primary">[[ invoice.invoice_number ]]</strong>
                    </td>
                    <td>[[ formatDate(invoice.invoice_date) ]]</td>
                    <td>[[ invoice.branch ? invoice.branch.name : 'N/A' ]]</td>
                    <td>[[ invoice.customer.name ]]</td>
                    <td>
                        <span v-if="invoice.booking" class="badge bg-info">
                            [[ invoice.booking.booking_number || `Booking #${invoice.booking.id}` ]]
                        </span>
                        <span v-else class="text-muted">Manual</span>
                    </td>
                    <td>
                        <span v-for="(s, sIndex) in invoice.services" :key="s.id">
                            [[ s.name ]]<span v-if="sIndex < invoice.services.length - 1">, </span>
                        </span>
                        <span v-if="invoice.services.length === 0" class="text-muted">No services</span>
                    </td>
                    <td>$[[ invoice.subtotal ]]</td>
                    <td>$[[ invoice.tax ]]</td>
                    <td>$[[ invoice.additional_fee ]]</td>
                    <td>
                        <strong class="text-success">$[[ invoice.grand_total ]]</strong>
                    </td>
                    <td>
                        <span :class="getStatusClass(invoice.status)">
                            [[ invoice.status_display || capitalize(invoice.status) ]]
                        </span>
                    </td>
                    <td>
                        <span class="text-capitalize">[[ invoice.payment_method_display || invoice.payment_method ]]</span>
                    </td>
                    <td>
                        [[ invoice.payment_deadline ? formatDate(invoice.payment_deadline) : 'N/A' ]]
                    </td>
                    <td>
                        <span v-if="invoice.notes" class="text-truncate" style="max-width: 150px;" :title="invoice.notes">
                            [[ invoice.notes ]]
                        </span>
                        <span v-else class="text-muted">N/A</span>
                    </td>
                    <td style="display: flex; gap: 0.5rem; justify-content: center;">

                        <button class="btn btn-sm btn-warning" @click="openModal('edit', invoice)" :disabled="isLoading">
                           Edit
                        </button>
                        <button class="btn btn-sm btn-danger" @click="deleteInvoice(invoice.id)" :disabled="isLoading">
                            Delete
                        </button>
                    </td>
                </tr>
                <tr v-if="invoices.length === 0 && !isLoading">
                    <td colspan="16" class="text-muted">No invoices found.</td>
                </tr>
            </tbody>
        </table>
    </div>

    <nav v-if="totalPages > 1">
        <ul class="pagination justify-content-end">
            <li class="page-item" :class="{ disabled: currentPage === 1 }">
                <a class="page-link" href="#" @click.prevent="changePage(currentPage - 1)">Previous</a>
            </li>
            <li class="page-item" v-for="page in totalPages" :class="{ active: currentPage === page }" :key="page">
                <a class="page-link" href="#" @click.prevent="changePage(page)">[[ page ]]</a>
            </li>
            <li class="page-item" :class="{ disabled: currentPage === totalPages }">
                <a class="page-link" href="#" @click.prevent="changePage(currentPage + 1)">Next</a>
            </li>
        </ul>
    </nav>

    <div v-if="isLoading" class="loading-overlay d-flex justify-content-center align-items-center">
        <div class="spinner-border text-primary" role="status" aria-label="Loading..."></div>
    </div>

    <!-- Invoice Modal -->
    <div class="modal fade" id="invoiceModal" tabindex="-1" aria-labelledby="invoiceModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <form @submit.prevent="saveInvoice" novalidate>
                    <input type="hidden" name="csrfmiddlewaretoken" :value="csrfToken">
                    <div class="modal-header">
                        <h5 class="modal-title" id="invoiceModalLabel">[[ modalTitle ]]</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close" :disabled="isLoading"></button>
                    </div>
                    <div class="modal-body">

                        <!-- Creation Method Selection -->
                        <div class="row mb-4" v-if="status === 'add'">
                          <div class="col-12">
                            <label class="form-label fw-semibold mb-3 text-secondary">Create Invoice From:</label>
                            <div class="creation-method d-flex flex-wrap gap-3">

                              <!-- Manual Entry -->
                              <div
                                class="method-option"
                                :class="{ 'active': creationMethod === 'manual' }"
                                @click="creationMethod = 'manual'"
                              >
                                <div class="icon-wrap">
                                  <i class="fas fa-pen"></i>
                                </div>
                                <div class="method-text">
                                  <h6 class="fw-semibold mb-1">Manual Entry</h6>
                                  <p class="text-muted small mb-0">
                                    Create an invoice from scratch by manually entering all details
                                  </p>
                                </div>
                                <div class="check-icon">
                                  <i class="fas fa-circle-check"></i>
                                </div>
                              </div>

                              <!-- From Booking -->
                              <div
                                class="method-option"
                                :class="{ 'active': creationMethod === 'booking' }"
                                @click="creationMethod = 'booking'"
                              >
                                <div class="icon-wrap">
                                  <i class="fas fa-calendar-check"></i>
                                </div>
                                <div class="method-text">
                                  <h6 class="fw-semibold mb-1">From Booking</h6>
                                  <p class="text-muted small mb-0">
                                    Generate an invoice automatically from an existing booking
                                  </p>
                                </div>
                                <div class="check-icon">
                                  <i class="fas fa-circle-check"></i>
                                </div>
                              </div>

                            </div>
                          </div>
                        </div>


                        <!-- Booking Selection (when creation method is 'booking') -->
                        <div class="row mb-3" v-if="status === 'add' && creationMethod === 'booking'">
                            <div class="col-12">
                                <label for="bookingSelect" class="form-label">Select Booking *</label>
                                <select
                                    id="bookingSelect"
                                    v-model="selectedBookingId"
                                    class="form-control"
                                    :disabled="isLoading"
                                    @change="onBookingSelect"
                                    aria-describedby="bookingError"
                                >
                                    <option :value="null" disabled>Select a booking...</option>
                                    <option v-for="booking in availableBookings" :value="booking.id" :key="booking.id">
                                        [[ booking.booking_number || `Booking #${booking.id}` ]] -
                                        [[ booking.customer.name ]] -
                                        [[ formatDate(booking.booking_date) ]] -
                                        $[[ booking.total_amount ]]
                                    </option>
                                </select>
                                <div v-if="errors.booking_id" class="text-danger small" id="bookingError">
                                    [[ errors.booking_id[0] ]]
                                </div>
                                <div class="form-text">
                                    Selecting a booking will automatically populate customer, branch, and services.
                                </div>
                            </div>
                        </div>

                        <div class="row">
                            <!-- Left Column -->
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="invoiceNumber" class="form-label">Invoice Number *</label>
                                    <input
                                        id="invoiceNumber"
                                        v-model="form.invoice_number"
                                        type="text"
                                        class="form-control"
                                        required
                                        :disabled="true"
                                        aria-describedby="invoiceNumberError"
                                        placeholder="e.g., INV-2025-0001"
                                    >
                                    <div v-if="errors.invoice_number" class="text-danger small" id="invoiceNumberError">
                                        [[ errors.invoice_number[0] ]]
                                    </div>
                                </div>

                                <div class="mb-3">
                                    <label for="invoiceDate" class="form-label">Invoice Date *</label>
                                    <input
                                        id="invoiceDate"
                                        v-model="form.invoice_date"
                                        type="date"
                                        class="form-control"
                                        required
                                        :disabled="isLoading || (creationMethod === 'booking' && selectedBookingId)"
                                        aria-describedby="invoiceDateError"
                                    >
                                    <div v-if="errors.invoice_date" class="text-danger small" id="invoiceDateError">
                                        [[ errors.invoice_date[0] ]]
                                    </div>
                                </div>

                                <div class="mb-3">
                                    <label for="branchSelect" class="form-label">Branch</label>
                                    <select
                                        id="branchSelect"
                                        v-model="form.branch"
                                        class="form-control"
                                        :disabled="isLoading || (creationMethod === 'booking' && selectedBookingId)"
                                        aria-describedby="branchError"
                                    >
                                        <option :value="null">Select a branch...</option>
                                        <option v-for="branch in branches" :value="branch.id" :key="branch.id">
                                            [[ branch.name ]]
                                        </option>
                                    </select>
                                    <div v-if="errors.branch_id" class="text-danger small" id="branchError">
                                        [[ errors.branch_id[0] ]]
                                    </div>
                                </div>

                                <div class="mb-3">
                                    <label for="customerSelect" class="form-label">Customer *</label>
                                    <select
                                        id="customerSelect"
                                        v-model="form.customer"
                                        class="form-control"
                                        required
                                        :disabled="isLoading || (creationMethod === 'booking' && selectedBookingId)"
                                        aria-describedby="customerError"
                                    >
                                        <option :value="null" disabled>Select a customer...</option>
                                        <option v-for="customer in customers" :value="customer.id" :key="customer.id">
                                            [[ customer.name ]] - [[ customer.phone ]]
                                        </option>
                                    </select>
                                    <div v-if="errors.customer_id" class="text-danger small" id="customerError">
                                        [[ errors.customer_id[0] ]]
                                    </div>
                                </div>
                            </div>

                            <!-- Right Column -->
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="statusSelect" class="form-label">Status *</label>
                                    <select
                                        id="statusSelect"
                                        v-model="form.status"
                                        class="form-control"
                                        required
                                        :disabled="isLoading"
                                        aria-describedby="statusError"
                                    >
                                        <option value="draft">Draft</option>
                                        <option value="issued">Issued</option>
                                        <option value="paid">Paid</option>
                                        <option value="cancelled">Cancelled</option>
                                    </select>
                                    <div v-if="errors.status" class="text-danger small" id="statusError">
                                        [[ errors.status[0] ]]
                                    </div>
                                </div>

                                <div class="mb-3">
                                    <label for="paymentMethod" class="form-label">Payment Method *</label>
                                    <select
                                        id="paymentMethod"
                                        v-model="form.payment_method"
                                        class="form-control"
                                        required
                                        :disabled="isLoading"
                                        aria-describedby="paymentMethodError"
                                    >
                                        <option value="cash">Cash</option>
                                        <option value="card">Card</option>
                                        <option value="bank_transfer">Bank Transfer</option>
                                        <option value="other">Other</option>
                                    </select>
                                    <div v-if="errors.payment_method" class="text-danger small" id="paymentMethodError">
                                        [[ errors.payment_method[0] ]]
                                    </div>
                                </div>

                                <div class="mb-3">
                                    <label for="paymentDeadline" class="form-label">Payment Deadline</label>
                                    <input
                                        id="paymentDeadline"
                                        v-model="form.payment_deadline"
                                        type="date"
                                        class="form-control"
                                        :disabled="isLoading"
                                        aria-describedby="paymentDeadlineError"
                                    >
                                    <div v-if="errors.payment_deadline" class="text-danger small" id="paymentDeadlineError">
                                        [[ errors.payment_deadline[0] ]]
                                    </div>
                                </div>

                                <div class="mb-3">
                                    <label for="additionalFee" class="form-label">Additional Fee ($)</label>
                                    <input
                                        id="additionalFee"
                                        v-model="form.additional_fee"
                                        type="number"
                                        step="0.01"
                                        min="0"
                                        class="form-control"
                                        :disabled="isLoading"
                                        aria-describedby="additionalFeeError"
                                        @input="calculateTotals"
                                    >
                                    <div v-if="errors.additional_fee" class="text-danger small" id="additionalFeeError">
                                        [[ errors.additional_fee[0] ]]
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Services Section - Full Width -->
                        <div class="row">
                            <div class="col-12">
                                <div class="mb-3">
                                    <label class="form-label">Services *</label>
                                    <div class="modern-multiselect">
                                        <!-- Selected Services Display -->
                                        <div class="selected-tags" v-if="form.service_ids.length > 0">
                                            <div v-for="serviceId in form.service_ids" :key="serviceId" class="service-tag">
                                                <span class="tag-text">[[ getServiceName(serviceId) ]]</span>
                                                <span class="tag-price">$[[ getServicePrice(serviceId) ]]</span>
                                                <button type="button" class="tag-remove" @click="removeService(serviceId)" aria-label="Remove service" :disabled="creationMethod === 'booking' && selectedBookingId">
                                                    <i class="fas fa-times"></i>
                                                </button>
                                            </div>
                                        </div>

                                        <!-- Search and Select Area -->
                                        <div class="multiselect-dropdown" v-if="creationMethod !== 'booking' || !selectedBookingId">
                                            <div class="dropdown-header" @click="toggleServicesDropdown">
                                                <span class="placeholder" v-if="form.service_ids.length === 0">
                                                    Select services...
                                                </span>
                                                <span class="selected-count" v-else>
                                                    [[ form.service_ids.length ]] service(s) selected - Subtotal: $[[ calculateSubtotal() ]]
                                                </span>
                                                <i class="dropdown-arrow" :class="{ 'rotated': showServicesDropdown }">â–¼</i>
                                            </div>

                                            <div class="dropdown-content" v-show="showServicesDropdown">
                                                <!-- Search Input -->
                                                <div class="search-box">
                                                    <input
                                                        type="text"
                                                        v-model="serviceSearch"
                                                        placeholder="Search services..."
                                                        class="search-input"
                                                        @input="filterServices"
                                                    >
                                                    <i class="fas fa-search search-icon"></i>
                                                </div>

                                                <!-- Services List -->
                                                <div class="services-list">
                                                    <div
                                                        v-for="service in filteredServices"
                                                        :key="service.id"
                                                        class="service-option"
                                                        :class="{ 'selected': form.service_ids.includes(service.id) }"
                                                        @click="toggleService(service.id)"
                                                    >
                                                        <div class="service-checkbox">
                                                            <i class="fas fa-check" v-if="form.service_ids.includes(service.id)"></i>
                                                        </div>
                                                        <div class="service-info">
                                                            <div class="service-name">[[ service.name ]]</div>
                                                            <div class="service-price">$[[ service.price ]]</div>
                                                        </div>
                                                    </div>
                                                    <div v-if="filteredServices.length === 0" class="no-services">
                                                        No services found
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        <div v-else class="booking-services-info">
                                            <div class="alert alert-info mb-0">
                                                <i class="fas fa-info-circle me-2"></i>
                                                Services are automatically populated from the selected booking.
                                            </div>
                                        </div>
                                    </div>
                                    <div v-if="errors.service_ids" class="text-danger small" id="serviceError">
                                        [[ errors.service_ids[0] ]]
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Totals Display -->
                        <div class="row mb-3">
                            <div class="col-md-3">
                                <div class="card bg-light">
                                    <div class="card-body py-2">
                                        <small class="text-muted">Subtotal</small>
                                        <div class="fw-bold">$[[ form.subtotal || '0.00' ]]</div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="card bg-light">
                                    <div class="card-body py-2">
                                        <small class="text-muted">Tax ([[ (taxRate * 100).toFixed(0) ]]%)</small>
                                        <div class="fw-bold">$[[ form.tax || '0.00' ]]</div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="card bg-light">
                                    <div class="card-body py-2">
                                        <small class="text-muted">Additional Fee</small>
                                        <div class="fw-bold">$[[ form.additional_fee || '0.00' ]]</div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="card bg-primary text-white">
                                    <div class="card-body py-2">
                                        <small>Grand Total</small>
                                        <div class="fw-bold">$[[ form.grand_total || '0.00' ]]</div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Notes -->
                        <div class="mb-3">
                            <label for="notesTextarea" class="form-label">Notes</label>
                            <textarea
                                id="notesTextarea"
                                v-model="form.notes"
                                class="form-control"
                                rows="3"
                                :disabled="isLoading"
                                aria-describedby="notesError"
                                placeholder="Additional notes or terms..."
                            ></textarea>
                            <div v-if="errors.notes" class="text-danger small" id="notesError">
                                [[ errors.notes[0] ]]
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="submit" class="btn btn-success" :disabled="isLoading">
                            <span v-if="isLoading" class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>
                            [[ status === 'add' ? 'Create Invoice' : 'Update Invoice' ]]
                        </button>
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" :disabled="isLoading">Cancel</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<style>

.creation-method {
  display: flex;
  gap: 1rem;
  flex-wrap: wrap;
}

.method-option {
  position: relative;
  flex: 1 1 250px;
  display: flex;
  align-items: flex-start;
  gap: 1rem;
  padding: 1rem 1.25rem;
  background: #fff;
  border: 1.5px solid #d9e2f3;
  border-radius: 12px;
  cursor: pointer;
  transition: all 0.25s ease-in-out;
}

.method-option:hover {
  border-color: #4a90e2;
  box-shadow: 0 0 0 3px rgba(74, 144, 226, 0.1);
}

.method-option.active {
  border-color: #4a90e2;
  background-color: #f0f6ff;
  box-shadow: 0 0 0 2px rgba(74, 144, 226, 0.25);
}

.icon-wrap {
  width: 40px;
  height: 40px;
  background-color: #e7f1ff;
  color: #4a90e2;
  border-radius: 8px;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 1.1rem;
}

.method-text h6 {
  color: #1a1a1a;
  font-weight: 600;
}

.method-text p {
  color: #6c757d;
  font-size: 0.85rem;
}

.check-icon {
  margin-left: auto;
  color: #4a90e2;
  font-size: 1.25rem;
  opacity: 0;
  transition: opacity 0.2s ease;
}

.method-option.active .check-icon {
  opacity: 1;
}

.loading-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(255,255,255,0.6);
    z-index: 1055;
}

.status-badge {
    padding: 0.25em 0.6em;
    font-weight: bold;
    color: #fff;
    border-radius: 0.25rem;
}

.status-draft { background-color: #6c757d; }
.status-issued { background-color: #0dcaf0; color: #000; }
.status-paid { background-color: #198754; }
.status-cancelled { background-color: #dc3545; }

/* Modern Multi-Select Styles */
.modern-multiselect {
    position: relative;
    width: 100%;
}

.selected-tags {
    display: flex;
    flex-wrap: wrap;
    gap: 0.5rem;
    margin-bottom: 0.75rem;
    padding: 0.5rem;
    background: #f8f9fa;
    border-radius: 0.375rem;
    min-height: 3rem;
    border: 1px solid #dee2e6;
}

.service-tag {
    display: flex;
    align-items: center;
    background: #007bff;
    color: white;
    padding: 0.375rem 0.75rem;
    border-radius: 1.5rem;
    font-size: 0.875rem;
    gap: 0.5rem;
}

.tag-text {
    font-weight: 500;
}

.tag-price {
    background: rgba(255, 255, 255, 0.2);
    padding: 0.125rem 0.375rem;
    border-radius: 0.75rem;
    font-size: 0.75rem;
}

.tag-remove {
    background: none;
    border: none;
    color: white;
    cursor: pointer;
    padding: 0.125rem;
    border-radius: 50%;
    width: 1.25rem;
    height: 1.25rem;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 0.75rem;
}

.tag-remove:hover {
    background: rgba(255, 255, 255, 0.2);
}

.tag-remove:disabled {
    cursor: not-allowed;
    opacity: 0.5;
}

.multiselect-dropdown {
    position: relative;
    border: 1px solid #dee2e6;
    border-radius: 0.375rem;
    background: white;
}

.dropdown-header {
    padding: 0.75rem 1rem;
    cursor: pointer;
    display: flex;
    justify-content: space-between;
    align-items: center;
    background: white;
    border-radius: 0.375rem;
}

.dropdown-header:hover {
    background: #f8f9fa;
}

.placeholder {
    color: #6c757d;
}

.selected-count {
    color: #007bff;
    font-weight: 500;
}

.dropdown-arrow {
    transition: transform 0.2s ease;
    color: #6c757d;
    font-size: 0.75rem;
}

.dropdown-arrow.rotated {
    transform: rotate(180deg);
}

.dropdown-content {
    position: absolute;
    top: 100%;
    left: 0;
    right: 0;
    background: white;
    border: 1px solid #dee2e6;
    border-radius: 0.375rem;
    box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.15);
    z-index: 1000;
    max-height: 300px;
    overflow-y: auto;
}

.search-box {
    position: relative;
    padding: 0.75rem;
    border-bottom: 1px solid #dee2e6;
}

.search-input {
    width: 100%;
    padding: 0.5rem 2rem 0.5rem 1rem;
    border: 1px solid #dee2e6;
    border-radius: 0.375rem;
    font-size: 0.875rem;
}

.search-input:focus {
    outline: none;
    border-color: #007bff;
    box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25);
}

.search-icon {
    position: absolute;
    right: 1.5rem;
    top: 50%;
    transform: translateY(-50%);
    color: #6c757d;
}

.services-list {
    max-height: 200px;
    overflow-y: auto;
}

.service-option {
    display: flex;
    align-items: center;
    padding: 0.75rem 1rem;
    cursor: pointer;
    border-bottom: 1px solid #f8f9fa;
    gap: 0.75rem;
}

.service-option:hover {
    background: #f8f9fa;
}

.service-option.selected {
    background: #e7f3ff;
}

.service-checkbox {
    width: 1.25rem;
    height: 1.25rem;
    border: 2px solid #dee2e6;
    border-radius: 0.25rem;
    display: flex;
    align-items: center;
    justify-content: center;
    background: white;
}

.service-option.selected .service-checkbox {
    background: #007bff;
    border-color: #007bff;
    color: white;
}

.service-checkbox i {
    font-size: 0.75rem;
}

.service-info {
    flex: 1;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.service-name {
    font-weight: 500;
    color: #212529;
}

.service-price {
    color: #28a745;
    font-weight: 500;
    font-size: 0.875rem;
}

.no-services {
    padding: 1rem;
    text-align: center;
    color: #6c757d;
    font-style: italic;
}

.booking-services-info {
    margin-top: 0.5rem;
}
.cursor-pointer {
    cursor: pointer;
}
.method-card:hover {
    background-color: #f8f9fa;
}
.method-card.active {
    border-color: #0d6efd;
    background-color: #f0f8ff;
}
</style>

<script src="https://unpkg.com/vue@3/dist/vue.global.prod.js"></script>
<script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/js/all.min.js"></script>

<script>
function getCSRFToken() {
    const csrfCookie = document.cookie.split('; ').find(row => row.startsWith('csrftoken='));
    return csrfCookie ? csrfCookie.split('=')[1] : null;
}

const { createApp } = Vue;

createApp({
    delimiters: ['[[', ']]'],
    data() {
        return {
            csrfToken: getCSRFToken(),
            invoices: [],
            branches: [],
            customers: [],
            services: [],
            availableBookings: [],
            filteredServices: [],
            form: {
                id: null,
                invoice_number: '',
                invoice_date: '',
                branch: null,
                customer: null,
                booking_id: null,
                service_ids: [],
                subtotal: '0.00',
                tax: '0.00',
                additional_fee: '0.00',
                grand_total: '0.00',
                status: 'draft',
                payment_method: 'cash',
                notes: '',
                payment_deadline: null
            },
            modalTitle: '',
            status: 'add',
            creationMethod: 'manual', // 'manual' or 'booking'
            selectedBookingId: null,
            message: '',
            searchQuery: '',
            currentPage: 1,
            totalPages: 1,
            perPage: 10,
            isLoading: false,
            errors: {},
            showServicesDropdown: false,
            serviceSearch: '',
            taxRate: 0.1 // 10% tax rate
        };
    },
    mounted() {
        this.debouncedFetch = this.debounce(this.fetchInvoices, 300);
        this.fetchInvoices();
        this.fetchBranches();
        this.fetchCustomers();
        this.fetchServices();
        this.fetchAvailableBookings();

        const modalEl = document.getElementById('invoiceModal');
        modalEl.addEventListener('hidden.bs.modal', () => {
            this.errors = {};
            this.resetForm();
            this.showServicesDropdown = false;
            this.serviceSearch = '';
            this.creationMethod = 'manual';
            this.selectedBookingId = null;
        });

        // Close dropdown when clicking outside
        document.addEventListener('click', (e) => {
            if (!e.target.closest('.modern-multiselect')) {
                this.showServicesDropdown = false;
            }
        });
    },
    methods: {
        debounce(func, delay) {
            let timeout;
            return function(...args) {
                clearTimeout(timeout);
                timeout = setTimeout(() => func.apply(this, args), delay);
            };
        },
        async fetchInvoices() {
            this.isLoading = true;
            try {
                const response = await axios.get('/api/invoices/', {
                    params: {
                        search: this.searchQuery,
                        page: this.currentPage,
                        page_size: this.perPage
                    },
                    headers: { 'X-CSRFToken': this.csrfToken }
                });

                this.invoices = response.data.results || response.data;
                this.totalPages = Math.ceil((response.data.count || response.data.length) / this.perPage);
            } catch (error) {
                console.error("Error fetching invoices:", error);
                Swal.fire({
                    icon: 'error',
                    title: 'Error',
                    text: 'Failed to fetch invoices'
                });
            } finally {
                this.isLoading = false;
            }
        },
        async fetchBranches() {
            try {
                const response = await axios.get('/api/branches/', { headers: { 'X-CSRFToken': this.csrfToken } });
                this.branches = response.data.results || response.data;
            } catch (error) {
                console.error("Error fetching branches:", error);
            }
        },
        async fetchCustomers() {
            try {
                const response = await axios.get('/api/customers/', { headers: { 'X-CSRFToken': this.csrfToken } });
                this.customers = response.data.results || response.data;
            } catch (error) {
                console.error("Error fetching customers:", error);
            }
        },
        async fetchServices() {
            try {
                const response = await axios.get('/api/services/', { headers: { 'X-CSRFToken': this.csrfToken } });
                this.services = response.data.results || response.data;
                this.filteredServices = [...this.services];
            } catch (error) {
                console.error("Error fetching services:", error);
            }
        },
        async fetchAvailableBookings() {
            try {
                // Fetch bookings that don't have invoices yet and are completed/confirmed
                const response = await axios.get('/api/bookings/', {
                    params: { has_invoice: false, status: 'completed' },
                    headers: { 'X-CSRFToken': this.csrfToken }
                });
                this.availableBookings = response.data.results || response.data;
            } catch (error) {
                console.error("Error fetching available bookings:", error);
            }
        },
        async onBookingSelect() {
            if (!this.selectedBookingId) return;

            try {
                const response = await axios.get(`/api/bookings/${this.selectedBookingId}/`, {
                    headers: { 'X-CSRFToken': this.csrfToken }
                });
                const booking = response.data;

                // Auto-populate form with booking data
                this.form.booking_id = booking.id;
                this.form.customer = booking.customer.id;
                this.form.branch = booking.branch ? booking.branch.id : null;
                this.form.service_ids = booking.services.map(service => service.id);

                // Use booking date as invoice date if not set
                if (!this.form.invoice_date && booking.booking_date) {
                    this.form.invoice_date = booking.booking_date;
                }

                // Calculate totals
                this.calculateTotals();

            } catch (error) {
                console.error("Error fetching booking details:", error);
                Swal.fire({
                    icon: 'error',
                    title: 'Error',
                    text: 'Failed to load booking details'
                });
            }
        },
        toggleServicesDropdown() {
            if (this.creationMethod === 'booking' && this.selectedBookingId) return;
            this.showServicesDropdown = !this.showServicesDropdown;
            if (this.showServicesDropdown) {
                this.filterServices();
            }
        },
        filterServices() {
            const searchTerm = this.serviceSearch.toLowerCase();
            this.filteredServices = this.services.filter(service =>
                service.name.toLowerCase().includes(searchTerm)
            );
        },
        toggleService(serviceId) {
            if (this.creationMethod === 'booking' && this.selectedBookingId) return;
            const index = this.form.service_ids.indexOf(serviceId);
            if (index > -1) {
                this.form.service_ids.splice(index, 1);
            } else {
                this.form.service_ids.push(serviceId);
            }
            this.calculateTotals();
        },
        removeService(serviceId) {
            if (this.creationMethod === 'booking' && this.selectedBookingId) return;
            this.form.service_ids = this.form.service_ids.filter(id => id !== serviceId);
            this.calculateTotals();
        },
        getServiceName(serviceId) {
            const service = this.services.find(s => s.id === serviceId);
            return service ? service.name : 'Unknown Service';
        },
        getServicePrice(serviceId) {
            const service = this.services.find(s => s.id === serviceId);
            return service ? parseFloat(service.price).toFixed(2) : '0.00';
        },
        calculateSubtotal() {
            return this.form.service_ids.reduce((total, serviceId) => {
                const service = this.services.find(s => s.id === serviceId);
                return total + (service ? parseFloat(service.price) : 0);
            }, 0).toFixed(2);
        },
        calculateTotals() {
            const subtotal = parseFloat(this.calculateSubtotal());
            const additionalFee = parseFloat(this.form.additional_fee) || 0;
            const tax = subtotal * this.taxRate;
            const grandTotal = subtotal + tax + additionalFee;

            this.form.subtotal = subtotal.toFixed(2);
            this.form.tax = tax.toFixed(2);
            this.form.grand_total = grandTotal.toFixed(2);
        },
        openModal(status, invoice = null) {
            this.status = status;
            this.modalTitle = status === 'add' ? 'Create New Invoice' : 'Edit Invoice';
            this.errors = {};
            this.resetForm();
            this.serviceSearch = '';
            this.filterServices();
            this.creationMethod = 'manual';
            this.selectedBookingId = null;

            if (status === 'edit' && invoice) {
                this.form = {
                    id: invoice.id,
                    invoice_number: invoice.invoice_number,
                    invoice_date: invoice.invoice_date,
                    branch: invoice.branch ? invoice.branch.id : null,
                    customer: invoice.customer.id,
                    booking_id: invoice.booking ? invoice.booking.id : null,
                    service_ids: invoice.services.map(s => s.id),
                    subtotal: invoice.subtotal,
                    tax: invoice.tax,
                    additional_fee: invoice.additional_fee || '0.00',
                    grand_total: invoice.grand_total,
                    status: invoice.status,
                    payment_method: invoice.payment_method,
                    notes: invoice.notes || '',
                    payment_deadline: invoice.payment_deadline
                };
                this.calculateTotals();
            } else {
                // Generate invoice number for new invoices
                this.generateInvoiceNumber();
                this.fetchAvailableBookings();
            }

            const modal = new bootstrap.Modal(document.getElementById('invoiceModal'));
            modal.show();
        },
        generateInvoiceNumber() {
            const now = new Date();
            const year = now.getFullYear();
            const month = String(now.getMonth() + 1).padStart(2, '0');
            const day = String(now.getDate()).padStart(2, '0');
            const random = Math.floor(Math.random() * 1000).toString().padStart(3, '0');
            this.form.invoice_number = `INV-${year}${month}${day}-${random}`;
            this.form.invoice_date = now.toISOString().split('T')[0];
        },
        resetForm() {
            this.form = {
                id: null,
                invoice_number: '',
                invoice_date: '',
                branch: null,
                customer: null,
                booking_id: null,
                service_ids: [],
                subtotal: '0.00',
                tax: '0.00',
                additional_fee: '0.00',
                grand_total: '0.00',
                status: 'draft',
                payment_method: 'cash',
                notes: '',
                payment_deadline: null
            };
        },
        async saveInvoice() {
            this.isLoading = true;
            this.errors = {};
            try {
                const url = this.status === 'add' ? '/api/invoices/' : `/api/invoices/${this.form.id}/`;
                const method = this.status === 'add' ? 'post' : 'put';

                // Prepare payload according to serializer expectations
                const payload = {
                    invoice_number: this.form.invoice_number,
                    invoice_date: this.form.invoice_date,
                    customer_id: this.form.customer,
                    status: this.form.status,
                    payment_method: this.form.payment_method,
                    notes: this.form.notes,
                    payment_deadline: this.form.payment_deadline || null
                };

                // Add optional fields only if they have values
                if (this.form.branch) {
                    payload.branch_id = this.form.branch;
                }

                if (this.form.service_ids.length > 0) {
                    payload.service_ids = this.form.service_ids;
                }

                if (this.form.additional_fee) {
                    payload.additional_fee = parseFloat(this.form.additional_fee);
                }

                // Add booking_id if creating from booking
                if (this.status === 'add' && this.creationMethod === 'booking' && this.selectedBookingId) {
                    payload.booking_id = this.selectedBookingId;
                }

                const response = await axios({
                    method,
                    url,
                    data: payload,
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': this.csrfToken
                    }
                });

                this.fetchInvoices();
                bootstrap.Modal.getInstance(document.getElementById('invoiceModal')).hide();
                this.message = this.status === 'add' ? 'Invoice created successfully!' : 'Invoice updated successfully!';
                setTimeout(() => this.message = '', 3000);
            } catch (error) {
                if (error.response?.status === 400) {
                    this.errors = error.response.data;
                    // Handle field name mapping if needed
                    if (this.errors.services) {
                        this.errors.service_ids = this.errors.services;
                    }
                } else {
                    console.error('Error saving invoice:', error);
                    Swal.fire({
                        icon: 'error',
                        title: 'Error',
                        text: 'Failed to save invoice: ' + (error.response?.data?.detail || error.message)
                    });
                }
            } finally {
                this.isLoading = false;
            }
        },
        async deleteInvoice(id) {
            const result = await Swal.fire({
                title: 'Are you sure?',
                text: 'This action cannot be undone.',
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#d33',
                cancelButtonColor: '#3085d6',
                confirmButtonText: 'Delete',
                cancelButtonText: 'Cancel'
            });

            if (result.isConfirmed) {
                try {
                    await axios.delete(`/api/invoices/${id}/`, {
                        headers: { 'X-CSRFToken': this.csrfToken }
                    });
                    this.fetchInvoices();
                    Swal.fire('Deleted!', 'Invoice deleted successfully.', 'success');
                } catch (error) {
                    console.error('Error deleting invoice:', error);
                    Swal.fire({
                        icon: 'error',
                        title: 'Error',
                        text: 'Failed to delete invoice'
                    });
                }
            }
        },
        viewInvoice(id) {
            window.open(`/invoices/${id}/view/`, '_blank');
        },
        changePage(page) {
            if (page < 1 || page > this.totalPages) return;
            this.currentPage = page;
            this.fetchInvoices();
        },
        formatDate(dateStr) {
            if (!dateStr) return 'N/A';
            const date = new Date(dateStr);
            return date.toLocaleDateString(undefined, { year: 'numeric', month: 'short', day: 'numeric' });
        },
        capitalize(str) {
            if (!str) return '';
            return str.charAt(0).toUpperCase() + str.slice(1);
        },
        getStatusClass(status) {
            const statusMap = {
                'draft': 'status-draft',
                'issued': 'status-issued',
                'paid': 'status-paid',
                'cancelled': 'status-cancelled'
            };
            return ['status-badge', statusMap[status] || 'status-draft'];
        }
    }
}).mount('#invoiceApp');
</script>
{% endblock %}