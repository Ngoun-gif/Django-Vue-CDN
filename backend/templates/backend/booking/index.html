{% extends "backend/layouts/master.html" %}

{% block content %}
<div id="bookingApp" class="container-fluid px-4 py-3" style="position: relative;">
    <!-- ... (keep your existing breadcrumb, alerts, and header) ... -->
    <nav aria-label="breadcrumb" class="mb-4">
        <ol class="breadcrumb">
            <li class="breadcrumb-item"><a href="#">Dashboard</a></li>
            <li class="breadcrumb-item active">Bookings</li>
        </ol>
    </nav>

    <div v-if="message" class="alert alert-success" role="alert">
        [[ message ]]
    </div>

    <div class="d-flex justify-content-between align-items-center mb-3">
        <div class="w-50">
            <div class="input-group">
                <input
                    v-model="searchQuery"
                    @input="debouncedFetch"
                    type="text"
                    class="form-control"
                    placeholder="Search bookings..."
                    aria-label="Search bookings"
                >
            </div>
        </div>

        <button class="btn btn-primary" @click="openModal('add')">
            <i class="fas fa-plus me-1"></i> Add Booking
        </button>
    </div>

    <!-- ... (keep your existing table) ... -->
    <div class="table-responsive">
        <table class="table table-bordered table-hover text-center">
            <thead class="table-light">
                <tr>
                    <th>Booking ID</th>
                    <th>Branch</th>
                    <th>Customer</th>
                    <th>Services</th>
                    <th>Total Price</th>
                    <th>Booking Date</th>
                    <th>Booking Time</th>
                    <th>Status</th>
                    <th>Note</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                <tr v-for="(booking, index) in bookings" :key="booking.id">
                    <td>[[ index + 1 + (currentPage - 1) * perPage ]]</td>
                    <td>[[ booking.branch.name ]]</td>
                    <td>[[ booking.customer.name ]]</td>
                    <td>
                        <span v-for="s in booking.services" :key="s.id">
                            [[ s.name ]]<span v-if="!isLastService(booking.services, s)">, </span>
                        </span>
                    </td>
                    <td>$[[ parseFloat(booking.total_price).toFixed(2) ]]</td>

                    <td>[[ formatDate(booking.booking_date) ]]</td>
                    <td>[[ formatTime(booking.booking_time) ]]</td>
                    <td>
                        <span :class="getStatusClass(booking.status)">
                            [[ capitalize(booking.status) ]]
                        </span>
                    </td>
                    <td>[[ booking.notes || 'N/A' ]]</td>
                    <td style="display: flex; gap: 0.5rem; justify-content: center;">
                        <button class="btn btn-sm btn-warning" @click="openModal('edit', booking)" :disabled="isLoading">Edit</button>
                        <button class="btn btn-sm btn-danger" @click="deleteBooking(booking.id)" :disabled="isLoading">Delete</button>
                    </td>
                </tr>
                <tr v-if="bookings.length === 0 && !isLoading">
                    <td colspan="10" class="text-muted">No bookings found.</td>
                </tr>
            </tbody>
        </table>
    </div>

    <nav v-if="totalPages > 1">
        <ul class="pagination justify-content-end">
            <li class="page-item" :class="{ disabled: currentPage === 1 }">
                <a class="page-link" href="#" @click.prevent="changePage(currentPage - 1)">Previous</a>
            </li>
            <li class="page-item" v-for="page in totalPages" :class="{ active: currentPage === page }" :key="page">
                <a class="page-link" href="#" @click.prevent="changePage(page)">[[ page ]]</a>
            </li>
            <li class="page-item" :class="{ disabled: currentPage === totalPages }">
                <a class="page-link" href="#" @click.prevent="changePage(currentPage + 1)">Next</a>
            </li>
        </ul>
    </nav>

    <div v-if="isLoading" class="loading-overlay d-flex justify-content-center align-items-center">
        <div class="spinner-border text-primary" role="status" aria-label="Loading..."></div>
    </div>

    <div class="modal fade" id="bookingModal" tabindex="-1" aria-labelledby="bookingModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <form @submit.prevent="saveBooking" novalidate>
                    <input type="hidden" name="csrfmiddlewaretoken" :value="csrfToken">
                    <div class="modal-header">
                        <h5 class="modal-title" id="bookingModalLabel">[[ modalTitle ]]</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close" :disabled="isLoading"></button>
                    </div>
                    <div class="modal-body">
                        <div class="mb-2">
                            <label for="branchSelect" class="form-label">Branch *</label>
                            <select id="branchSelect" v-model="form.branch" class="form-control" required :disabled="isLoading" aria-describedby="branchError">
                                <option :value="null" disabled>Select a branch...</option>
                                <option v-for="branch in branches" :value="branch.id" :key="branch.id">[[ branch.name ]]</option>
                            </select>
                            <div v-if="errors.branch" class="text-danger small" id="branchError">[[ errors.branch[0] ]]</div>
                        </div>

                        <div class="mb-2">
                            <label for="customerSelect" class="form-label">Customer *</label>
                            <select id="customerSelect" v-model="form.customer" class="form-control" required :disabled="isLoading" aria-describedby="customerError">
                                <option :value="null" disabled>Select a customer...</option>
                                <option v-for="customer in customers" :value="customer.id" :key="customer.id">[[ customer.name ]]</option>
                            </select>
                            <div v-if="errors.customer" class="text-danger small" id="customerError">[[ errors.customer[0] ]]</div>
                        </div>

                        <!-- Enhanced Services Multi-Select -->
                        <div class="mb-2">
                            <label class="form-label">Services *</label>
                            <div class="modern-multiselect">
                                <!-- Selected Services Display -->
                                <div class="selected-tags" v-if="form.service_ids.length > 0">
                                    <div v-for="serviceId in form.service_ids" :key="serviceId" class="service-tag">
                                        <span class="tag-text">[[ getServiceName(serviceId) ]]</span>
                                        <span class="tag-price">$[[ getServicePrice(serviceId) ]]</span>
                                        <button type="button" class="tag-remove" @click="removeService(serviceId)" aria-label="Remove service">
                                            <i class="fas fa-times"></i>
                                        </button>
                                    </div>
                                </div>

                                <!-- Search and Select Area -->
                                <div class="multiselect-dropdown">
                                    <div class="dropdown-header" @click="toggleServicesDropdown">
                                        <span class="placeholder" v-if="form.service_ids.length === 0">
                                            Select services...
                                        </span>
                                        <span class="selected-count" v-else>
                                            [[ form.service_ids.length ]] service(s) selected - Total: $[[ calculateTotalPrice() ]]
                                        </span>
                                        <i class="dropdown-arrow" :class="{ 'rotated': showServicesDropdown }">â–¼</i>
                                    </div>

                                    <div class="dropdown-content" v-show="showServicesDropdown">
                                        <!-- Search Input -->
                                        <div class="search-box">
                                            <input
                                                type="text"
                                                v-model="serviceSearch"
                                                placeholder="Search services..."
                                                class="search-input"
                                                @input="filterServices"
                                            >
                                            <i class="fas fa-search search-icon"></i>
                                        </div>

                                        <!-- Services List -->
                                        <div class="services-list">
                                            <div
                                                v-for="service in filteredServices"
                                                :key="service.id"
                                                class="service-option"
                                                :class="{ 'selected': form.service_ids.includes(service.id) }"
                                                @click="toggleService(service.id)"
                                            >
                                                <div class="service-checkbox">
                                                    <i class="fas fa-check" v-if="form.service_ids.includes(service.id)"></i>
                                                </div>
                                                <div class="service-info">
                                                    <div class="service-name">[[ service.name ]]</div>
                                                    <div class="service-price">$[[ service.price ]]</div>
                                                </div>
                                            </div>
                                            <div v-if="filteredServices.length === 0" class="no-services">
                                                No services found
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div v-if="errors.services" class="text-danger small" id="serviceError">
                                [[ errors.services[0] ]]
                            </div>
                        </div>

                        <div class="mb-2">
                            <label for="dateInput" class="form-label">Booking Date *</label>
                            <input id="dateInput" v-model="form.booking_date" type="date" class="form-control" required :disabled="isLoading" aria-describedby="dateError">
                            <div v-if="errors.booking_date" class="text-danger small" id="dateError">[[ errors.booking_date[0] ]]</div>
                        </div>

                        <div class="mb-2">
                            <label for="timeInput" class="form-label">Booking Time *</label>
                            <input id="timeInput" v-model="form.booking_time" type="time" class="form-control" required :disabled="isLoading" aria-describedby="timeError">
                            <div v-if="errors.booking_time" class="text-danger small" id="timeError">[[ errors.booking_time[0] ]]</div>
                        </div>

                        <div class="mb-2">
                            <label for="statusSelect" class="form-label">Status *</label>
                            <select id="statusSelect" v-model="form.status" class="form-control" required :disabled="isLoading" aria-describedby="statusError">
                                <option value="pending">Pending</option>
                                <option value="confirmed">Confirmed</option>
                                <option value="completed">Completed</option>
                                <option value="cancelled">Cancelled</option>
                            </select>
                            <div v-if="errors.status" class="text-danger small" id="statusError">[[ errors.status[0] ]]</div>
                        </div>

                        <div class="mb-2">
                            <label for="notesTextarea" class="form-label">Note</label>
                            <textarea id="notesTextarea" v-model="form.notes" class="form-control" rows="3" :disabled="isLoading" aria-describedby="notesError"></textarea>
                            <div v-if="errors.notes" class="text-danger small" id="notesError">[[ errors.notes[0] ]]</div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="submit" class="btn btn-success" :disabled="isLoading">
                            <span v-if="isLoading" class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>
                            [[ status === 'add' ? 'Create' : 'Update' ]]
                        </button>
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" :disabled="isLoading">Cancel</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<style>
.loading-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(255,255,255,0.6);
    z-index: 1055;
}
.status-badge {
    padding: 0.25em 0.6em;
    font-weight: bold;
    color: #fff;
    border-radius: 0.25rem;
}
.status-pending { background-color: #ffc107; color: #000; }
.status-confirmed { background-color: #0d6efd; }
.status-completed { background-color: #198754; }
.status-cancelled { background-color: #dc3545; }

/* Modern Multi-Select Styles */
.modern-multiselect {
    position: relative;
    width: 100%;
}

.selected-tags {
    display: flex;
    flex-wrap: wrap;
    gap: 0.5rem;
    margin-bottom: 0.75rem;
    padding: 0.5rem;
    background: #f8f9fa;
    border-radius: 0.375rem;
    min-height: 3rem;
    border: 1px solid #dee2e6;
}

.service-tag {
    display: flex;
    align-items: center;
    background: #007bff;
    color: white;
    padding: 0.375rem 0.75rem;
    border-radius: 1.5rem;
    font-size: 0.875rem;
    gap: 0.5rem;
}

.tag-text {
    font-weight: 500;
}

.tag-price {
    background: rgba(255, 255, 255, 0.2);
    padding: 0.125rem 0.375rem;
    border-radius: 0.75rem;
    font-size: 0.75rem;
}

.tag-remove {
    background: none;
    border: none;
    color: white;
    cursor: pointer;
    padding: 0.125rem;
    border-radius: 50%;
    width: 1.25rem;
    height: 1.25rem;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 0.75rem;
}

.tag-remove:hover {
    background: rgba(255, 255, 255, 0.2);
}

.multiselect-dropdown {
    position: relative;
    border: 1px solid #dee2e6;
    border-radius: 0.375rem;
    background: white;
}

.dropdown-header {
    padding: 0.75rem 1rem;
    cursor: pointer;
    display: flex;
    justify-content: space-between;
    align-items: center;
    background: white;
    border-radius: 0.375rem;
}

.dropdown-header:hover {
    background: #f8f9fa;
}

.placeholder {
    color: #6c757d;
}

.selected-count {
    color: #007bff;
    font-weight: 500;
}

.dropdown-arrow {
    transition: transform 0.2s ease;
    color: #6c757d;
    font-size: 0.75rem;
}

.dropdown-arrow.rotated {
    transform: rotate(180deg);
}

.dropdown-content {
    position: absolute;
    top: 100%;
    left: 0;
    right: 0;
    background: white;
    border: 1px solid #dee2e6;
    border-radius: 0.375rem;
    box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.15);
    z-index: 1000;
    max-height: 300px;
    overflow-y: auto;
}

.search-box {
    position: relative;
    padding: 0.75rem;
    border-bottom: 1px solid #dee2e6;
}

.search-input {
    width: 100%;
    padding: 0.5rem 2rem 0.5rem 1rem;
    border: 1px solid #dee2e6;
    border-radius: 0.375rem;
    font-size: 0.875rem;
}

.search-input:focus {
    outline: none;
    border-color: #007bff;
    box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25);
}

.search-icon {
    position: absolute;
    right: 1.5rem;
    top: 50%;
    transform: translateY(-50%);
    color: #6c757d;
}

.services-list {
    max-height: 200px;
    overflow-y: auto;
}

.service-option {
    display: flex;
    align-items: center;
    padding: 0.75rem 1rem;
    cursor: pointer;
    border-bottom: 1px solid #f8f9fa;
    gap: 0.75rem;
}

.service-option:hover {
    background: #f8f9fa;
}

.service-option.selected {
    background: #e7f3ff;
}

.service-checkbox {
    width: 1.25rem;
    height: 1.25rem;
    border: 2px solid #dee2e6;
    border-radius: 0.25rem;
    display: flex;
    align-items: center;
    justify-content: center;
    background: white;
}

.service-option.selected .service-checkbox {
    background: #007bff;
    border-color: #007bff;
    color: white;
}

.service-checkbox i {
    font-size: 0.75rem;
}

.service-info {
    flex: 1;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.service-name {
    font-weight: 500;
    color: #212529;
}

.service-price {
    color: #28a745;
    font-weight: 500;
    font-size: 0.875rem;
}

.no-services {
    padding: 1rem;
    text-align: center;
    color: #6c757d;
    font-style: italic;
}
</style>

<script src="https://unpkg.com/vue@3/dist/vue.global.prod.js"></script>
<script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/js/all.min.js"></script>

<script>
function getCSRFToken() {
    const csrfCookie = document.cookie.split('; ').find(row => row.startsWith('csrftoken='));
    return csrfCookie ? csrfCookie.split('=')[1] : null;
}

const { createApp } = Vue;

createApp({
    delimiters: ['[[', ']]'],
    data() {
        return {
            csrfToken: getCSRFToken(),
            bookings: [],
            branches: [],
            customers: [],
            services: [],
            filteredServices: [],
            form: {
                id: null,
                branch: null,
                customer: null,
                service_ids: [],
                booking_date: '',
                booking_time: '',
                status: 'pending',
                notes: ''
            },
            modalTitle: '',
            status: 'add',
            message: '',
            searchQuery: '',
            currentPage: 1,
            totalPages: 1,
            perPage: 10,
            isLoading: false,
            errors: {},
            showServicesDropdown: false,
            serviceSearch: ''
        };
    },
    mounted() {
        this.debouncedFetch = this.debounce(this.fetchBookings, 300);
        this.fetchBookings();
        this.fetchBranches();
        this.fetchCustomers();
        this.fetchServices();

        const modalEl = document.getElementById('bookingModal');
        modalEl.addEventListener('hidden.bs.modal', () => {
            this.errors = {};
            this.resetForm();
            this.showServicesDropdown = false;
            this.serviceSearch = '';
        });

        // Close dropdown when clicking outside
        document.addEventListener('click', (e) => {
            if (!e.target.closest('.modern-multiselect')) {
                this.showServicesDropdown = false;
            }
        });
    },
    methods: {
        debounce(func, delay) {
            let timeout;
            return function(...args) {
                clearTimeout(timeout);
                timeout = setTimeout(() => func.apply(this, args), delay);
            };
        },
        isLastService(arr, s) {
            return arr.indexOf(s) === arr.length - 1;
        },
        async fetchBookings() {
            this.isLoading = true;
            try {
                const response = await axios.get('/api/bookings/', {
                    params: {
                        search: this.searchQuery,
                        page: this.currentPage,
                        page_size: this.perPage
                    },
                    headers: { 'X-CSRFToken': this.csrfToken }
                });

                this.bookings = response.data.results || response.data;
                this.totalPages = Math.ceil((response.data.count || response.data.length) / this.perPage);
            } catch (error) {
                console.error("Error fetching bookings:", error);
            } finally {
                this.isLoading = false;
            }
        },
        async fetchBranches() {
            try {
                const response = await axios.get('/api/branches/', { headers: { 'X-CSRFToken': this.csrfToken } });
                this.branches = response.data.results || response.data;
            } catch (error) { console.error(error); }
        },
        async fetchCustomers() {
            try {
                const response = await axios.get('/api/customers/', { headers: { 'X-CSRFToken': this.csrfToken } });
                this.customers = response.data.results || response.data;
            } catch (error) { console.error(error); }
        },
        async fetchServices() {
            try {
                const response = await axios.get('/api/services/', { headers: { 'X-CSRFToken': this.csrfToken } });
                this.services = response.data.results || response.data;
                this.filteredServices = [...this.services];
            } catch (error) { console.error(error); }
        },
        toggleServicesDropdown() {
            this.showServicesDropdown = !this.showServicesDropdown;
            if (this.showServicesDropdown) {
                this.filterServices();
            }
        },
        filterServices() {
            const searchTerm = this.serviceSearch.toLowerCase();
            this.filteredServices = this.services.filter(service =>
                service.name.toLowerCase().includes(searchTerm)
            );
        },
        toggleService(serviceId) {
            const index = this.form.service_ids.indexOf(serviceId);
            if (index > -1) {
                this.form.service_ids.splice(index, 1);
            } else {
                this.form.service_ids.push(serviceId);
            }
        },
        removeService(serviceId) {
            this.form.service_ids = this.form.service_ids.filter(id => id !== serviceId);
        },
        getServiceName(serviceId) {
            const service = this.services.find(s => s.id === serviceId);
            return service ? service.name : 'Unknown Service';
        },
        getServicePrice(serviceId) {
            const service = this.services.find(s => s.id === serviceId);
            return service ? parseFloat(service.price).toFixed(2) : '0.00';
        },
        calculateTotalPrice() {
            return this.form.service_ids.reduce((total, serviceId) => {
                const service = this.services.find(s => s.id === serviceId);
                return total + (service ? parseFloat(service.price) : 0);
            }, 0).toFixed(2);
        },
        openModal(status, booking = null) {
            this.status = status;
            this.modalTitle = status === 'add' ? 'Add Booking' : 'Edit Booking';
            this.errors = {};
            this.resetForm();
            this.serviceSearch = '';
            this.filterServices();
            if (status === 'edit' && booking) {
                this.form = {
                    id: booking.id,
                    branch: booking.branch.id,
                    customer: booking.customer.id,
                    service_ids: booking.services.map(s => s.id),
                    booking_date: booking.booking_date,
                    booking_time: booking.booking_time,
                    status: booking.status,
                    notes: booking.notes || ''
                };
            }
            const modal = new bootstrap.Modal(document.getElementById('bookingModal'));
            modal.show();
        },
        resetForm() {
            this.form = {
                id: null,
                branch: null,
                customer: null,
                service_ids: [],
                booking_date: '',
                booking_time: '',
                status: 'pending',
                notes: ''
            };
        },
        async saveBooking() {
            this.isLoading = true;
            this.errors = {};
            try {
                const url = this.status === 'add' ? '/api/bookings/' : `/api/bookings/${this.form.id}/`;
                const method = this.status === 'add' ? 'post' : 'put';
                const payload = {
                    branch_id: this.form.branch,
                    customer_id: this.form.customer,
                    service_ids: this.form.service_ids,
                    booking_date: this.form.booking_date,
                    booking_time: this.form.booking_time,
                    status: this.form.status,
                    notes: this.form.notes
                };
                await axios({ method, url, data: payload, headers: { 'Content-Type': 'application/json', 'X-CSRFToken': this.csrfToken }});
                this.fetchBookings();
                bootstrap.Modal.getInstance(document.getElementById('bookingModal')).hide();
                this.message = this.status === 'add' ? 'Booking created successfully!' : 'Booking updated successfully!';
                setTimeout(() => this.message = '', 3000);
            } catch (error) {
                if (error.response?.status === 400) { this.errors = error.response.data; }
                else { console.error(error); Swal.fire({icon:'error',title:'Error',text:'Failed to save booking'}); }
            } finally { this.isLoading = false; }
        },
        deleteBooking(id) {
            Swal.fire({
                title: 'Are you sure?',
                text: 'This action cannot be undone.',
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#d33',
                cancelButtonColor: '#3085d6',
                confirmButtonText: 'Delete',
                cancelButtonText: 'Cancel'
            }).then(async (result) => {
                if (result.isConfirmed) {
                    try { await axios.delete(`/api/bookings/${id}/`, { headers: { 'X-CSRFToken': this.csrfToken }}); this.fetchBookings(); Swal.fire('Deleted!', 'Booking deleted.', 'success'); }
                    catch (error) { console.error(error); Swal.fire({icon:'error',title:'Error',text:'Failed to delete booking'}); }
                }
            });
        },
        changePage(page) { if (page < 1 || page > this.totalPages) return; this.currentPage = page; this.fetchBookings(); },
        formatDate(dateStr) { if (!dateStr) return ''; const date = new Date(dateStr); return date.toLocaleDateString(undefined, { year: 'numeric', month: 'short', day: 'numeric' }); },
        formatTime(timeStr) { if (!timeStr) return ''; const [hours, minutes] = timeStr.split(':'); const date = new Date(); date.setHours(hours, minutes, 0); return date.toLocaleTimeString(undefined, { hour: '2-digit', minute: '2-digit', hour12: true }); },
        capitalize(str) { if (!str) return ''; return str.charAt(0).toUpperCase() + str.slice(1); },
        getStatusClass(status) { const statusMap = { 'pending':'status-pending','confirmed':'status-confirmed','completed':'status-completed','cancelled':'status-cancelled' }; return ['status-badge', statusMap[status] || '']; }
    }
}).mount('#bookingApp');
</script>
{% endblock %}