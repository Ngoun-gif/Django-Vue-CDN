{% extends "backend/layouts/master.html" %}
{% load static %}

{% block content %}
<div id="userApp" class="container-fluid py-4">
    <div v-if="errorMessage" class="alert alert-danger mb-3">
        [[ errorMessage ]]
        <button type="button" class="btn-close float-end" @click="errorMessage = ''"></button>
    </div>

    <div class="d-flex justify-content-between mb-3">
        <input 
            type="text" 
            v-model="searchQuery" 
            @input="debouncedFetch" 
            class="form-control w-50 me-2" 
            placeholder="Search users..."
            aria-label="Search users"
        >
        <button class="btn btn-primary" @click="openModal('add')" :disabled="isLoading">
            <span v-if="isLoading" class="spinner-border spinner-border-sm me-1" role="status"></span>
            + Add User
        </button>
    </div>

    <div class="table-responsive">
        <table class="table table-bordered text-center">
            <thead class="table-light">
                <tr>
                    <th>#</th>
                    <th>Username</th>
                    <th>Email</th>
                    <th>Role</th>
                    <th>Status</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                <tr v-for="(user, index) in filteredUsers" :key="user?.id || index">
                    <td>[[ index + 1 + (currentPage - 1) * perPage ]]</td>
                    <td>[[ user?.username || 'N/A' ]]</td>
                    <td>[[ user?.email || 'N/A' ]]</td>
                    <td>[[ user?.role_name || '—' ]]</td>
                    <td>
                        <span v-if="user?.active" class="badge bg-success">Active</span>
                        <span v-else class="badge bg-secondary">Inactive</span>
                    </td>
                    <td>
                        <button class="btn btn-sm btn-warning me-1" @click="openModal('edit', user)" :disabled="!user || isLoading">
                            Edit
                        </button>
                        <button class="btn btn-sm btn-danger" @click="confirmDelete(user?.id)" :disabled="!user || isLoading">
                            Delete
                        </button>
                    </td>
                </tr>
                <tr v-if="filteredUsers.length === 0 && !isLoading">
                    <td colspan="6" class="text-muted">No users found.</td>
                </tr>
            </tbody>
        </table>
    </div>

    <nav v-if="totalPages > 1" aria-label="User pagination">
        <ul class="pagination justify-content-end">
            <li class="page-item" :class="{ disabled: currentPage === 1 }">
                <a class="page-link" href="#" @click.prevent="changePage(currentPage - 1)">Previous</a>
            </li>
            <li class="page-item" v-for="page in visiblePages" :key="page" :class="{ active: currentPage === page }">
                <a class="page-link" href="#" @click.prevent="changePage(page)">[[ page ]]</a>
            </li>
            <li class="page-item" :class="{ disabled: currentPage === totalPages }">
                <a class="page-link" href="#" @click.prevent="changePage(currentPage + 1)">Next</a>
            </li>
        </ul>
    </nav>

    <div class="modal fade" id="userModal" tabindex="-1" aria-labelledby="userModalLabel" aria-hidden="true" ref="userModal">
        <div class="modal-dialog">
            <form @submit.prevent="saveUser" novalidate>
                <input type="hidden" :value="csrfToken" name="csrfmiddlewaretoken" />
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="userModalLabel">[[ modalTitle ]]</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close" :disabled="isLoading"></button>
                    </div>
                    <div class="modal-body">
                        <div class="mb-3">
                            <label for="usernameInput" class="form-label">Username *</label>
                            <input
                                id="usernameInput"
                                v-model="form.username"
                                type="text"
                                class="form-control"
                                :class="{ 'is-invalid': errors.username }"
                                required
                                :disabled="isLoading || status === 'edit'"
                            >
                            <div v-if="errors.username" class="invalid-feedback">
                                [[ errors.username[0] ]]
                            </div>
                        </div>

                        <div class="mb-3">
                            <label for="emailInput" class="form-label">Email *</label>
                            <input
                                id="emailInput"
                                v-model="form.email"
                                type="email"
                                class="form-control"
                                :class="{ 'is-invalid': errors.email }"
                                required
                                :disabled="isLoading"
                            >
                            <div v-if="errors.email" class="invalid-feedback">
                                [[ errors.email[0] ]]
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="firstNameInput" class="form-label">First Name</label>
                                <input
                                    id="firstNameInput"
                                    v-model="form.first_name"
                                    type="text"
                                    class="form-control"
                                    :disabled="isLoading"
                                >
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="lastNameInput" class="form-label">Last Name</label>
                                <input
                                    id="lastNameInput"
                                    v-model="form.last_name"
                                    type="text"
                                    class="form-control"
                                    :disabled="isLoading"
                                >
                            </div>
                        </div>

                        <div class="mb-3">
                            <label for="passwordInput" class="form-label">
                                <span v-if="status === 'add'">Password *</span>
                                <span v-else>New Password (leave blank to keep)</span>
                            </label>
                            <input
                                id="passwordInput"
                                v-model="form.password"
                                type="password"
                                class="form-control"
                                :class="{ 'is-invalid': errors.password }"
                                :required="status === 'add'"
                                :disabled="isLoading"
                                autocomplete="new-password"
                            >
                            <div v-if="errors.password" class="invalid-feedback">
                                [[ errors.password[0] ]]
                            </div>
                        </div>

                        <div class="form-check mb-3">
                            <input
                                class="form-check-input"
                                type="checkbox"
                                id="activeCheckbox"
                                v-model="form.is_active"
                                :disabled="isLoading"
                            >
                            <label class="form-check-label" for="activeCheckbox">Active</label>
                        </div>

                        <div class="mb-3">
                            <label for="roleSelect" class="form-label">Role *</label>
                            <select
                                id="roleSelect"
                                class="form-control"
                                :class="{ 'is-invalid': errors.role_id }"
                                v-model="form.role_id"
                                required
                                :disabled="isLoading || roles.length === 0"
                            >
                                <option value="" disabled>Select Role</option>
                                <option v-for="role in roles" :key="role.id" :value="role.id">
                                    [[ role.name ]]
                                </option>
                            </select>
                            <div v-if="errors.role_id" class="invalid-feedback">
                                [[ errors.role_id[0] ]]
                            </div>
                            <div v-if="roles.length === 0" class="text-warning small mt-1">
                                No roles available. Please check your roles API endpoint or add roles first.
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" :disabled="isLoading">Cancel</button>
                        <button type="submit" class="btn btn-primary" :disabled="isLoading || roles.length === 0">
                            <span v-if="isLoading" class="spinner-border spinner-border-sm me-2" role="status"></span>
                            [[ status === 'add' ? 'Create' : 'Update' ]]
                        </button>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <div v-if="isLoading" class="loading-overlay d-flex justify-content-center align-items-center">
        <div class="spinner-border text-primary" style="width: 3rem; height: 3rem;" role="status">
            <span class="visually-hidden">Loading...</span>
        </div>
    </div>
</div>

<style>
.loading-overlay {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(255,255,255,0.6);
  z-index: 1055;
}
</style>

<script src="https://unpkg.com/vue@3/dist/vue.global.prod.js"></script>
<script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<script>
function getCSRFToken() {
    const cookie = document.cookie.split('; ').find(c => c.startsWith('csrftoken='));
    return cookie ? decodeURIComponent(cookie.split('=')[1]) : '';
}

const { createApp } = Vue;

createApp({
    delimiters: ['[[', ']]'],
    data() {
        return {
            csrfToken: getCSRFToken(),
            users: [],
            filteredUsers: [],
            roles: [],
            form: {
                id: null,
                username: '',
                email: '',
                first_name: '',
                last_name: '',
                password: '',
                is_active: true,
                role_id: '' // Renamed from 'role' to 'role_id'
            },
            modalTitle: '',
            status: 'add',
            errors: {},
            errorMessage: '',
            searchQuery: '',
            currentPage: 1,
            totalPages: 1,
            perPage: 10,
            isLoading: false,
            debounceTimeout: null,
            maxVisiblePages: 5,
            debouncedFetch: null
        };
    },
    computed: {
        visiblePages() {
            const range = [];
            const start = Math.max(1, this.currentPage - Math.floor(this.maxVisiblePages / 2));
            const end = Math.min(this.totalPages, start + this.maxVisiblePages - 1);
            
            for (let i = start; i <= end; i++) {
                range.push(i);
            }
            
            return range;
        }
    },
    mounted() {
        this.debouncedFetch = this.debounce(this.fetchUsers, 500);
        this.initApp();
    },
    methods: {
        async initApp() {
            this.isLoading = true;
            try {
                await Promise.all([
                    this.fetchRoles(),
                    this.fetchUsers()
                ]);
            } catch (error) {
                console.error('Initialization error:', error);
                this.errorMessage = 'Failed to initialize application. Please refresh the page.';
            } finally {
                this.isLoading = false;
            }
        },
        
        getUserRoleDisplay(user) {
            return user?.role_name || '—';
        },
        
        debounce(func, delay) {
            return (...args) => {
                clearTimeout(this.debounceTimeout);
                this.debounceTimeout = setTimeout(() => func.apply(this, args), delay);
            };
        },
        
        async fetchRoles() {
            this.isLoading = true;
            try {
                const res = await axios.get('/api/roles/');
                
                let rolesData = Array.isArray(res.data) ? res.data : 
                               (res.data?.results || []);
                
                this.roles = rolesData
                    .filter(role => role && (role.id || role._id))
                    .map(role => ({
                        id: role.id || role._id,
                        name: role.name || 'Unnamed Role'
                    }));
                
            } catch (error) {
                console.error('Roles API error:', error);
                this.roles = [];
                this.errorMessage = 'Could not load roles from the server.';
            } finally {
                this.isLoading = false;
            }
        },
        
        async fetchUsers() {
            this.isLoading = true;
            try {
                const res = await axios.get('/api/users/', {
                    params: {
                        search: this.searchQuery,
                        page: this.currentPage,
                        page_size: this.perPage
                    }
                });
                
                const usersData = res.data?.results || res.data || [];
                
                this.users = usersData.map(user => ({
                    ...user,
                    is_active: user.active,
                    // Find the role ID from our `roles` list to populate the form dropdown
                    role_id: this.roles.find(r => r.name === user.role_name)?.id || '' 
                }));
                
                this.filteredUsers = [...this.users];
                this.totalPages = Math.ceil((res.data?.count || this.users.length) / this.perPage);
                
            } catch (error) {
                console.error('Failed to fetch users:', error);
                this.errorMessage = 'Failed to load users. Please try again.';
                this.users = [];
                this.filteredUsers = [];
            } finally {
                this.isLoading = false;
            }
        },
        
        openModal(status, user = null) {
            if (this.isLoading) return;
            
            this.status = status;
            this.modalTitle = status === 'add' ? 'Add User' : 'Edit User';
            this.errors = {};
            
            if (status === 'add') {
                this.form = {
                    id: null,
                    username: '',
                    email: '',
                    first_name: '',
                    last_name: '',
                    password: '',
                    is_active: true,
                    role_id: this.roles.length > 0 ? this.roles[0].id : ''
                };
            } else if (user) {
                this.form = {
                    id: user.id,
                    username: user.username,
                    email: user.email,
                    first_name: user.first_name,
                    last_name: user.last_name,
                    password: '',
                    is_active: user.is_active,
                    role_id: user.role_id 
                };
            }
            
            const modal = new bootstrap.Modal(this.$refs.userModal);
            modal.show();
        },
        
        async saveUser() {
            if (this.isLoading) return;
            
            this.isLoading = true;
            this.errors = {};
            
            try {
                // Basic validation
                if (!this.form.username.trim()) {
                    throw { response: { data: { username: ['Username is required'] } } };
                }
                if (!this.form.email.trim()) {
                    throw { response: { data: { email: ['Email is required'] } } };
                }
                if (!this.form.role_id) {
                    throw { response: { data: { role_id: ['Role is required'] } } };
                }
                if (this.status === 'add' && !this.form.password.trim()) {
                    throw { response: { data: { password: ['Password is required for new users'] } } };
                }

                const url = this.status === 'add' 
                    ? '/api/users/' 
                    : `/api/users/${this.form.id}/`;
                
                const method = this.status === 'add' ? 'post' : 'patch';
                
                const payload = {
                    username: this.form.username.trim(),
                    email: this.form.email.trim(),
                    first_name: this.form.first_name.trim(),
                    last_name: this.form.last_name.trim(),
                    active: this.form.is_active, 
                    role_id: this.form.role_id // Changed 'role' to 'role_id'
                };
                
                if (this.form.password.trim()) {
                    payload.password = this.form.password.trim();
                }
                
                await axios({
                    method,
                    url,
                    data: payload,
                    headers: { 'X-CSRFToken': this.csrfToken }
                });
                
                await this.fetchUsers();
                bootstrap.Modal.getInstance(this.$refs.userModal).hide();
                
                Swal.fire({
                    title: 'Success',
                    text: `User ${this.status === 'add' ? 'created' : 'updated'} successfully!`,
                    icon: 'success',
                    timer: 2000,
                    showConfirmButton: false
                });
                
            } catch (error) {
                console.error('Error saving user:', error);
                
                if (error.response?.status === 400) {
                    this.errors = error.response.data;
                } else {
                    this.errorMessage = error.response?.data?.message || 
                                     'Failed to save user. Please check your data.';
                }
            } finally {
                this.isLoading = false;
            }
        },
        
        confirmDelete(userId) {
            if (!userId) {
                this.errorMessage = 'Invalid user ID';
                return;
            }
            
            Swal.fire({
                title: 'Are you sure?',
                text: "You won't be able to revert this!",
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#d33',
                cancelButtonColor: '#3085d6',
                confirmButtonText: 'Yes, delete it!'
            }).then(async (result) => {
                if (result.isConfirmed) {
                    await this.deleteUser(userId);
                }
            });
        },
        
        async deleteUser(userId) {
            this.isLoading = true;
            try {
                await axios.delete(`/api/users/${userId}/`, {
                    headers: { 'X-CSRFToken': this.csrfToken }
                });
                
                await this.fetchUsers();
                
                Swal.fire({
                    title: 'Deleted!',
                    text: 'User has been deleted.',
                    icon: 'success',
                    timer: 2000,
                    showConfirmButton: false
                });
            } catch (error) {
                console.error('Failed to delete user:', error);
                
                let errorMsg = 'Failed to delete user.';
                if (error.response?.status === 404) {
                    errorMsg = 'User not found. It may have already been deleted.';
                } else if (error.response?.data?.message) {
                    errorMsg = error.response.data.message;
                }
                
                this.errorMessage = errorMsg;
            } finally {
                this.isLoading = false;
            }
        },
        
        changePage(page) {
            if (page < 1 || page > this.totalPages || this.isLoading) return;
            this.currentPage = page;
            this.fetchUsers();
        }
    }
}).mount('#userApp');
</script>
{% endblock %}