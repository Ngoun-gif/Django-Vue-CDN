{% extends "backend/layouts/master.html" %}

{% block content %}
<div id="teacherApp" class="container-fluid px-4 py-3" style="position: relative;">
    <!-- Breadcrumb -->
    <nav aria-label="breadcrumb" class="mb-4">
        <ol class="breadcrumb">
            <li class="breadcrumb-item"><a href="#">Dashboard</a></li>
            <li class="breadcrumb-item active">Teachers</li>
        </ol>
    </nav>

    <!-- Success Alert -->
    <div v-if="message" class="alert alert-success" role="alert">
        [[ message ]]
    </div>

    <!-- Search + Add Button -->
    <div class="d-flex justify-content-between align-items-center mb-3">
        <div class="w-50">
            <div class="input-group">
                <input 
                    v-model="searchQuery" 
                    @input="debouncedFetch" 
                    type="text" 
                    class="form-control" 
                    placeholder="Search teacher..."
                >
            </div>
        </div>
        <button class="btn btn-primary" @click="openModal('add')">
            <i class="fas fa-plus me-1"></i> Add Teacher
        </button>
    </div>

    <!-- Teachers Table -->
    <div class="table-responsive">
        <table class="table table-bordered table-hover text-center">
            <thead class="table-light">
                <tr>
                    <th>#</th>
                    <th>First Name</th>
                    <th>Last Name</th>
                    <th>Gender</th>
                    <th>Date of Birth</th>
                    <th>Salary</th>
                    <th>Subject</th>
                    <th>Photo</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                <tr v-for="(teacher, index) in teachers" :key="teacher.id">
                    <td>[[ index + 1 ]]</td>
                    <td>[[ teacher.first_name ]]</td>
                    <td>[[ teacher.last_name ]]</td>
                    <td>[[ teacher.gender ]]</td>
                    <td>[[ formatDate(teacher.date_of_birth) ]]</td>
                    <td>$[[ teacher.salary ]]</td>
                    <td>[[ getSubjectName(teacher.subject) ]]</td>
                    <td>
                        <img v-if="teacher.photo" :src="teacher.photo" alt="Teacher Photo" style="width:50px;height:50px;object-fit:cover;">
                        <span v-else>No Photo</span>
                    </td>
                    <td style="display: flex; gap: 0.5rem; justify-content: center;">
                        <button class="btn btn-sm btn-warning" @click="openModal('edit', teacher)" :disabled="isLoading">Edit</button>
                        <button class="btn btn-sm btn-danger" @click="deleteTeacher(teacher.id)" :disabled="isLoading">Delete</button>
                    </td>
                </tr>
                <tr v-if="teachers.length === 0 && !isLoading">
                    <td colspan="9" class="text-muted">No teachers found.</td>
                </tr>
            </tbody>
        </table>
    </div>

    <!-- Pagination -->
    <nav v-if="totalPages > 1">
        <ul class="pagination justify-content-end">
            <li class="page-item" :class="{ disabled: currentPage === 1 }">
                <a class="page-link" href="#" @click.prevent="changePage(currentPage - 1)">Previous</a>
            </li>
            <li class="page-item" v-for="page in totalPages" :class="{ active: currentPage === page }" :key="page">
                <a class="page-link" href="#" @click.prevent="changePage(page)">[[ page ]]</a>
            </li>
            <li class="page-item" :class="{ disabled: currentPage === totalPages }">
                <a class="page-link" href="#" @click.prevent="changePage(currentPage + 1)">Next</a>
            </li>
        </ul>
    </nav>

    <!-- Loading Overlay -->
    <div v-if="isLoading" class="loading-overlay d-flex justify-content-center align-items-center">
        <div class="spinner-border text-primary" role="status" aria-label="Loading..."></div>
    </div>

    <!-- Teacher Modal -->
    <div class="modal fade" id="teacherModal" tabindex="-1" aria-labelledby="teacherModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <form @submit.prevent="saveTeacher" novalidate>
                    <input type="hidden" name="csrfmiddlewaretoken" :value="csrfToken">
                    <div class="modal-header">
                        <h5 class="modal-title">[[ modalTitle ]]</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close" :disabled="isLoading"></button>
                    </div>
                    <div class="modal-body">
                        <div class="mb-2">
                            <label class="form-label">First Name *</label>
                            <input v-model="form.first_name" type="text" class="form-control" required :disabled="isLoading">
                        </div>
                        <div class="mb-2">
                            <label class="form-label">Last Name *</label>
                            <input v-model="form.last_name" type="text" class="form-control" required :disabled="isLoading">
                        </div>
                        <div class="mb-2">
                            <label class="form-label">Gender *</label>
                            <select v-model="form.gender" class="form-control" required :disabled="isLoading">
                                <option disabled value="">Select gender...</option>
                                <option value="M">Male</option>
                                <option value="F">Female</option>
                                <option value="O">Other</option>
                            </select>
                        </div>
                        <div class="mb-2">
                            <label class="form-label">Date of Birth *</label>
                            <input v-model="form.date_of_birth" type="date" class="form-control" required :disabled="isLoading">
                        </div>
                        <div class="mb-2">
                            <label class="form-label">Salary *</label>
                            <input v-model="form.salary" type="number" step="0.01" class="form-control" required :disabled="isLoading">
                        </div>
                        <div class="mb-2">
                            <label class="form-label">Subject *</label>
                            <select v-model="form.subject" class="form-control" required :disabled="isLoading">
                                <option disabled value="">Select subject...</option>
                                <option v-for="subject in subjects" :value="subject.id" :key="subject.id">[[ subject.name ]]</option>
                            </select>
                        </div>
                        <div class="mb-2">
                            <label class="form-label">Photo</label>
                            <input type="file" @change="handleFileUpload" class="form-control" :disabled="isLoading">
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="submit" class="btn btn-success" :disabled="isLoading">
                            <span v-if="isLoading" class="spinner-border spinner-border-sm me-2"></span>
                            [[ status === 'add' ? 'Create' : 'Update' ]]
                        </button>
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" :disabled="isLoading">Cancel</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<style>
.loading-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(255,255,255,0.6);
    z-index: 1055;
}
</style>

<script src="https://unpkg.com/vue@3/dist/vue.global.prod.js"></script>
<script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<script>
function getCSRFToken() {
    const csrfCookie = document.cookie.split('; ').find(row => row.startsWith('csrftoken='));
    return csrfCookie ? csrfCookie.split('=')[1] : null;
}

const { createApp } = Vue;

createApp({
    delimiters: ['[[', ']]'],
    data() {
        return {
            csrfToken: getCSRFToken(),
            teachers: [],
            subjects: [],
            form: { 
                id: null,
                first_name: '',
                last_name: '',
                gender: '',
                date_of_birth: '',
                salary: '',
                subject: '',
                photo: null
            },
            modalTitle: '',
            status: 'add',
            message: '',
            searchQuery: '',
            currentPage: 1,
            totalPages: 1,
            perPage: 5,
            isLoading: false
        };
    },
    mounted() {
        this.debouncedFetch = this.debounce(this.fetchTeachers, 300);
        this.fetchTeachers();
        this.fetchSubjects();

        const modalEl = document.getElementById('teacherModal');
        modalEl.addEventListener('hidden.bs.modal', () => {
            this.resetForm();
        });
    },
    methods: {
        debounce(func, delay) {
            let timeout;
            return function(...args) {
                clearTimeout(timeout);
                timeout = setTimeout(() => func.apply(this, args), delay);
            };
        },
        async fetchTeachers() {
            this.isLoading = true;
            try {
                const response = await axios.get('/api/teachers/', {
                    params: {
                        search: this.searchQuery,
                        page: this.currentPage,
                        page_size: this.perPage
                    },
                    headers: { 'X-CSRFToken': this.csrfToken }
                });
                this.teachers = response.data.results || response.data;
                this.totalPages = Math.ceil((response.data.count || response.data.length) / this.perPage);
            } catch (error) {
                console.error("Error fetching teachers:", error);
                this.showError("Failed to load teachers");
            } finally {
                this.isLoading = false;
            }
        },
        async fetchSubjects() {
            try {
                const response = await axios.get('/api/subjects/', {
                    headers: { 'X-CSRFToken': this.csrfToken }
                });
                this.subjects = response.data.results || response.data;
            } catch (error) {
                console.error("Error fetching subjects:", error);
            }
        },
        getSubjectName(subjectId) {
            if (!subjectId) return 'N/A';
            const subject = this.subjects.find(s => s.id === subjectId);
            return subject ? subject.name : 'N/A';
        },
        openModal(status, teacher = null) {
            this.status = status;
            this.modalTitle = status === 'add' ? 'Add Teacher' : 'Edit Teacher';
            this.resetForm();
            if (status === 'edit' && teacher) {
                this.form = {
                    id: teacher.id,
                    first_name: teacher.first_name,
                    last_name: teacher.last_name,
                    gender: teacher.gender,
                    date_of_birth: teacher.date_of_birth,
                    salary: teacher.salary,
                    subject: teacher.subject,
                    photo: null
                };
            }
            const modal = new bootstrap.Modal(document.getElementById('teacherModal'));
            modal.show();
        },
        resetForm() {
            this.form = { 
                id: null,
                first_name: '',
                last_name: '',
                gender: '',
                date_of_birth: '',
                salary: '',
                subject: '',
                photo: null
            };
        },
        handleFileUpload(event) {
            this.form.photo = event.target.files[0];
        },
        async saveTeacher() {
            this.isLoading = true;
            try {
                const url = this.status === 'add' ? '/api/teachers/' : `/api/teachers/${this.form.id}/`;
                const method = this.status === 'add' ? 'post' : 'put';

                const formData = new FormData();
                formData.append('first_name', this.form.first_name);
                formData.append('last_name', this.form.last_name);
                formData.append('gender', this.form.gender);
                formData.append('date_of_birth', this.form.date_of_birth);
                formData.append('salary', this.form.salary);
                formData.append('subject', this.form.subject);
                if (this.form.photo) {
                    formData.append('photo', this.form.photo);
                }

                await axios({
                    method,
                    url,
                    data: formData,
                    headers: {
                        'Content-Type': 'multipart/form-data',
                        'X-CSRFToken': this.csrfToken
                    }
                });

                this.fetchTeachers();
                bootstrap.Modal.getInstance(document.getElementById('teacherModal')).hide();
                this.showSuccess(this.status === 'add' ? 'Teacher created successfully!' : 'Teacher updated successfully!');
            } catch (error) {
                console.error("Error saving teacher:", error);
                this.showError("Failed to save teacher");
            } finally {
                this.isLoading = false;
            }
        },
        deleteTeacher(id) {
            Swal.fire({
                title: 'Are you sure?',
                text: 'This action cannot be undone.',
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#d33',
                cancelButtonColor: '#3085d6',
                confirmButtonText: 'Delete'
            }).then(async (result) => {
                if (result.isConfirmed) {
                    try {
                        await axios.delete(`/api/teachers/${id}/`, {
                            headers: { 'X-CSRFToken': this.csrfToken }
                        });
                        this.fetchTeachers();
                        this.showSuccess('Teacher deleted successfully!');
                    } catch (error) {
                        console.error("Error deleting teacher:", error);
                        this.showError("Failed to delete teacher");
                    }
                }
            });
        },
        changePage(page) {
            if (page < 1 || page > this.totalPages) return;
            this.currentPage = page;
            this.fetchTeachers();
        },
        showSuccess(message) {
            this.message = message;
            setTimeout(() => this.message = '', 3000);
        },
        showError(message) {
            Swal.fire({ icon: 'error', title: 'Error', text: message });
        },
        formatDate(dateStr) {
            if (!dateStr) return '';
            const date = new Date(dateStr);
            return date.toLocaleDateString(undefined, { year: 'numeric', month: 'short', day: 'numeric' });
        }
    }
}).mount('#teacherApp');
</script>
{% endblock %}
